<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiVerse - Tạp chí Khoa học & Công nghệ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Thư viện để chuyển đổi Markdown thành HTML -->
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>

    <style>
        /* CSS VẪN GIỮ NGUYÊN GIAO DIỆN "XỊN" NHƯ CŨ */
        :root {
            --primary-color: #0A2F5B; --secondary-color: #005A9C; --accent-color: #E8A87C;
            --text-color: #333333; --light-gray: #f8f9fa; --border-color: #dee2e6;
            --font-heading: 'Lora', serif; --font-body: 'Montserrat', sans-serif;
            --shadow: 0 4px 15px rgba(0,0,0,0.07);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); line-height: 1.7; color: var(--text-color); background-color: #ffffff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .loader-overlay.show { opacity: 1; visibility: visible; }
        .loader { border: 8px solid var(--light-gray); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .main-header { background-color: #fff; border-bottom: 1px solid var(--border-color); padding: 15px 0; position: sticky; top: 0; z-index: 1000; transition: box-shadow 0.3s ease; }
        .main-header.scrolled { box-shadow: var(--shadow); }
        .main-header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-heading); color: var(--primary-color); font-size: 2.5rem; margin: 0; font-weight: 700; text-decoration: none; }
        
        .hero-section { background: linear-gradient(rgba(10, 47, 91, 0.85), rgba(10, 47, 91, 0.85)), url('https://placehold.co/1920x1080/0A2F5B/FFFFFF?text=PhysiVerse+Background') no-repeat center center; background-size: cover; color: #fff; text-align: center; padding: 120px 0; }
        .hero-section h2 { font-family: var(--font-heading); font-size: 3.5rem; margin-bottom: 20px; font-weight: 700; }
        .hero-section p { font-size: 1.25rem; max-width: 700px; margin: 0 auto 40px auto; opacity: 0.9; }
        .btn-secondary { background-color: var(--accent-color); color: #fff; padding: 12px 28px; font-size: 1.05rem; text-decoration: none; border-radius: 5px; transition: all 0.3s ease; }
        .btn-secondary:hover { background-color: #d99160; transform: translateY(-2px); }

        .latest-issue { padding: 80px 0; background-color: var(--light-gray); min-height: 400px; }
        .section-title { text-align: center; font-family: var(--font-heading); font-size: 2.8rem; color: var(--primary-color); margin-bottom: 60px; position: relative; }
        .section-title::after { content: ''; display: block; width: 80px; height: 3px; background-color: var(--accent-color); margin: 15px auto 0; }
        
        #no-articles-message { text-align: center; color: #6c757d; padding: 50px 0; }
        #no-articles-message h3 { font-family: var(--font-heading); margin-bottom: 10px; }
        
        .filters-container { display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; max-width: 800px; margin: -20px auto 40px auto; }
        .search-bar { flex-grow: 1; min-width: 250px; }
        .search-bar input, .category-filter select { width: 100%; padding: 15px 20px; font-size: 1rem; border-radius: 50px; border: 1px solid var(--border-color); transition: box-shadow 0.3s; }
        .search-bar input:focus, .category-filter select:focus { outline: none; box-shadow: 0 0 0 4px rgba(0, 90, 156, 0.2); border-color: var(--secondary-color); }

        .articles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        .article-card { background-color: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; text-decoration: none; }
        .article-card:hover { transform: translateY(-8px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .article-image { width: 100%; height: 220px; object-fit: cover; background-color: var(--light-gray); }
        .article-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .article-category { display: inline-block; background-color: var(--secondary-color); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; align-self: flex-start; }
        .article-title { font-family: var(--font-heading); font-size: 1.4rem; margin-bottom: 10px; color: var(--primary-color); }
        .article-card:hover .article-title { color: var(--accent-color); }
        .article-authors { font-size: 0.9rem; color: #6c757d; margin-bottom: 15px; }
        .article-excerpt { margin-bottom: 20px; flex-grow: 1; color: var(--text-color); }
        
        .page-section { display: none; animation: slideUp 0.5s ease-in-out; }
        .page-section.active { display: block; }

        #articleDetailPage { padding: 80px 0; }
        .article-detail-container { max-width: 800px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 8px; box-shadow: var(--shadow); }
        .article-detail-header img { width: 100%; max-height: 400px; object-fit: cover; border-radius: 5px; margin-bottom: 20px; background-color: var(--light-gray); }
        .article-detail-header h1 { font-family: var(--font-heading); font-size: 2.8rem; color: var(--primary-color); line-height: 1.3; margin-bottom: 15px; }
        .article-meta { font-size: 0.9rem; color: #6c757d; margin-bottom: 30px; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 15px; background-color: var(--light-gray); border-radius: 5px; }
        .article-meta p { margin: 5px 0; }
        .article-meta strong { color: var(--text-color); }
        .article-full-content { font-size: 1.1rem; line-height: 1.8; }
        .article-full-content h1, .article-full-content h2, .article-full-content h3 { font-family: var(--font-heading); color: var(--primary-color); margin-top: 30px; margin-bottom: 15px; }
        .article-full-content p { margin-bottom: 1rem; }
        .article-full-content blockquote { border-left: 4px solid var(--accent-color); padding-left: 20px; margin: 20px 0; font-style: italic; color: #555; }
        .article-full-content img { max-width: 100%; height: auto; border-radius: 5px; margin: 1rem 0; }
        #backToHomeBtn { margin-bottom: 40px; display: inline-block; background-color: var(--primary-color); color: #fff; padding: 10px 20px; border-radius: 5px; text-decoration: none; transition: all 0.3s ease; }
        #backToHomeBtn:hover { background-color: var(--secondary-color); }

        #scrollToTopBtn { display: none; position: fixed; bottom: 30px; right: 30px; z-index: 99; border: none; outline: none; background-color: var(--primary-color); color: white; cursor: pointer; padding: 15px; border-radius: 50%; font-size: 18px; width: 50px; height: 50px; transition: all 0.3s; opacity: 0.8; }
        #scrollToTopBtn:hover { opacity: 1; transform: scale(1.1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="loader-overlay show" id="loader-overlay">
        <div class="loader"></div>
    </div>

    <header class="main-header" id="mainHeader">
        <div class="container">
            <a href="#" class="logo" id="logo-link">PhysiVerse</a>
        </div>
    </header>

    <main id="main-content">
        <!-- Nội dung sẽ được render vào đây bởi JavaScript -->
    </main>
    
    <button id="scrollToTopBtn" title="Lên đầu trang">&#8679;</button>

    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const ui = {
                loader: document.getElementById('loader-overlay'),
                header: document.getElementById('mainHeader'),
                mainContent: document.getElementById('main-content'),
                scrollToTopBtn: document.getElementById('scrollToTopBtn'),
                logoLink: document.getElementById('logo-link')
            };

            const showdownConverter = new showdown.Converter({ metadata: true });
            let allArticlesCache = [];

            const showLoader = () => ui.loader.classList.add('show');
            const hideLoader = () => ui.loader.classList.remove('show');

            const parseFrontMatter = (metadata) => {
                // Showdown's getMetadata() returns raw strings. We need to parse them.
                const parsed = {};
                for (const key in metadata) {
                    if (Object.hasOwnProperty.call(metadata, key)) {
                        parsed[key] = metadata[key].trim();
                    }
                }
                return parsed;
            };

            const fetchArticle = async (id) => {
                try {
                    const response = await fetch(`./articles/${id}.md`);
                    if (!response.ok) return null;
                    const markdown = await response.text();
                    const htmlContent = showdownConverter.makeHtml(markdown);
                    const metadata = parseFrontMatter(showdownConverter.getMetadata());
                    return { id, ...metadata, content: htmlContent };
                } catch (error) {
                    console.error(`Error fetching article ${id}.md:`, error);
                    return null;
                }
            };

            const fetchAllArticles = async () => {
                let articles = [];
                let id = 1;
                let continueFetching = true;
                while(continueFetching) {
                    const article = await fetchArticle(id);
                    if (article) {
                        articles.push(article);
                        id++;
                    } else {
                        continueFetching = false;
                    }
                }
                allArticlesCache = articles.sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));
            };

            const renderHomePage = (articlesToRender = allArticlesCache) => {
                const categories = [...new Set(allArticlesCache.map(a => a.category))];
                let articlesHTML = '';

                if (articlesToRender.length > 0) {
                    articlesToRender.forEach(article => {
                        articlesHTML += `
                            <a href="#article/${article.id}" class="article-card" data-id="${article.id}">
                                <img src="${article.coverImage}" alt="${article.title}" class="article-image">
                                <div class="article-content">
                                    <span class="article-category">${article.category}</span>
                                    <h4 class="article-title">${article.title}</h4>
                                    <p class="article-authors">Bởi ${article.authors}</p>
                                    <p class="article-excerpt">${article.excerpt}</p>
                                </div>
                            </a>`;
                    });
                }

                ui.mainContent.innerHTML = `
                    <section id="homePage" class="page-section active">
                        <section class="hero-section">
                            <div class="container">
                                <h2>Khám Phá Ranh Giới Mới Của Tri Thức</h2>
                                <p>Nơi công bố những nghiên cứu đột phá trong lĩnh vực Vật lý, Công nghệ và Trí tuệ nhân tạo.</p>
                                <a href="#latest-issue-section" class="btn-secondary">Xem Bài Mới Nhất</a>
                            </div>
                        </section>
                        <section class="latest-issue" id="latest-issue-section">
                            <div class="container">
                                <h3 class="section-title">Nghiên Cứu Nổi Bật</h3>
                                <div class="filters-container">
                                    <div class="search-bar">
                                        <input type="text" id="homeSearchInput" placeholder="Tìm kiếm bài báo...">
                                    </div>
                                    <div class="category-filter">
                                        <select id="categoryFilter">
                                            <option value="">Tất cả chuyên mục</option>
                                            ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                ${articlesToRender.length === 0 ? `
                                <div id="no-articles-message">
                                    <h3>Không tìm thấy bài báo nào.</h3>
                                </div>` : ''}
                                <div class="articles-grid">
                                    ${articlesHTML}
                                </div>
                            </div>
                        </section>
                    </section>`;

                document.getElementById('homeSearchInput')?.addEventListener('input', handleFilters);
                document.getElementById('categoryFilter')?.addEventListener('change', handleFilters);
            };

            const renderArticlePage = (article) => {
                ui.mainContent.innerHTML = `
                    <section id="articleDetailPage" class="page-section active">
                        <div class="container">
                            <a href="#" id="backToHomeBtn">&larr; Quay lại Trang chủ</a>
                            <div class="article-detail-container">
                                <div class="article-detail-header">
                                    <img src="${article.coverImage}" alt="Article Cover Image">
                                    <h1>${article.title}</h1>
                                    <div class="article-meta">
                                        <p><strong>Tác giả:</strong> ${article.authors}</p>
                                        <p><strong>Đơn vị:</strong> ${article.affiliation}</p>
                                        <p><strong>Email:</strong> <a href="mailto:${article.email}">${article.email}</a></p>
                                        <p><strong>Ngày đăng:</strong> ${article.date} | <strong>Chuyên ngành:</strong> ${article.category}</p>
                                    </div>
                                </div>
                                <div class="article-full-content">${article.content}</div>
                            </div>
                        </div>
                    </section>`;
            };

            const handleFilters = () => {
                const searchTerm = document.getElementById('homeSearchInput').value.toLowerCase();
                const selectedCategory = document.getElementById('categoryFilter').value;
                
                let filtered = allArticlesCache;

                if (searchTerm) {
                    filtered = filtered.filter(a => 
                        a.title.toLowerCase().includes(searchTerm) || 
                        a.authors.toLowerCase().includes(searchTerm)
                    );
                }

                if (selectedCategory) {
                    filtered = filtered.filter(a => a.category === selectedCategory);
                }
                
                renderHomePage(filtered);
                 // Re-attach listeners because the DOM is re-rendered
                document.getElementById('homeSearchInput').value = searchTerm;
                document.getElementById('categoryFilter').value = selectedCategory;
                document.getElementById('homeSearchInput').addEventListener('input', handleFilters);
                document.getElementById('categoryFilter').addEventListener('change', handleFilters);
            };
            
            const router = () => {
                const path = window.location.hash.slice(1);
                const articleIdMatch = path.match(/^article\/(\d+)$/);

                if (articleIdMatch) {
                    const articleId = parseInt(articleIdMatch[1]);
                    const article = allArticlesCache.find(a => a.id == articleId);
                    if (article) {
                        renderArticlePage(article);
                    } else {
                        // Handle case where article is not found after initial load
                        window.location.hash = ''; // Go back to home
                        renderHomePage();
                    }
                } else {
                    renderHomePage();
                }
                 window.scrollTo(0, 0);
            };

            // --- EVENT LISTENERS ---
            window.addEventListener('hashchange', router);

            ui.mainContent.addEventListener('click', (e) => {
                const articleLink = e.target.closest('a.article-card, a#backToHomeBtn, a.logo');
                if (articleLink) {
                    const articleId = articleLink.dataset.id;
                    if (articleId) {
                        window.location.hash = `article/${articleId}`;
                    } else {
                        window.location.hash = '';
                    }
                }
            });
            
            ui.logoLink.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
            });

            window.onscroll = () => {
                const isScrolled = document.body.scrollTop > 100 || document.documentElement.scrollTop > 100;
                ui.header.classList.toggle('scrolled', isScrolled);
                ui.scrollToTopBtn.style.display = isScrolled ? "block" : "none";
            };
            ui.scrollToTopBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
            

            // --- INITIALIZATION ---
            const init = async () => {
                showLoader();
                await fetchAllArticles();
                router();
                hideLoader();
            };

            init();
        });
    </script>
</body>
</html>
